# system_stm32f4xx.c


## void SystemInit(void)
1. 启用FPU，允许浮点运算。
2. 如果使用外部SRAM或SDRAM，初始化对应的存储器控制器。
3. 如果用户自定义了向量表地址，将其重定位到指定位置。

以下是对STM32F429平台中`SystemInit`函数代码的详细解读：

---

### **函数功能概述**
`SystemInit`是STM32系统启动时调用的关键初始化函数，主要完成以下任务：
1. **启用FPU**（浮点运算单元）
2. **初始化外部存储器控制器**（如果使用外部SRAM/SDRAM）
3. **配置中断向量表位置**（如果需要重定位）

---

### **代码逐段解析**

#### **1. FPU设置**
```c
#if (__FPU_PRESENT == 1) && (__FPU_USED == 1)
    SCB->CPACR |= ((3UL << 10*2)|(3UL << 11*2));  /* 设置CP10和CP11完全访问权限 */
#endif
```
- **作用**：启用FPU以支持单精度和双精度浮点运算。
- **条件编译**：
  - `__FPU_PRESENT == 1`：检测芯片是否内置FPU（STM32F429具备FPU）。
  - `__FPU_USED == 1`：检查工程是否启用FPU（通常在IDE中配置）。
- **寄存器操作**：
  - `SCB->CPACR`（协处理器访问控制寄存器）的位10-11和位20-21分别控制协处理器CP10和CP11。
  - 写入`3`（二进制`11`）赋予**完全访问权限**，从而激活FPU。

---

#### **2. 外部存储器初始化**
```c
#if defined (DATA_IN_ExtSRAM) || defined (DATA_IN_ExtSDRAM)
    SystemInit_ExtMemCtl(); 
#endif
```
- **作用**：如果使用外部SRAM或SDRAM存储数据，需初始化对应的控制器（如FSMC/FMC）。
- **条件编译**：
  - `DATA_IN_ExtSRAM`或`DATA_IN_ExtSDRAM`需在工程中定义（如`#define DATA_IN_ExtSDRAM`）。
- **函数调用**：
  - `SystemInit_ExtMemCtl()`：用户自定义函数，需实现外部存储器的时序、控制寄存器配置（如总线宽度、时序参数等）。

---

#### **3. 中断向量表重定位**
```c
#if defined(USER_VECT_TAB_ADDRESS)
    SCB->VTOR = VECT_TAB_BASE_ADDRESS | VECT_TAB_OFFSET; /* 将向量表重定位到内部SRAM */
#endif
```
- **作用**：将中断向量表从默认的Flash地址迁移到其他位置（如SRAM）。
- **条件编译**：
  - `USER_VECT_TAB_ADDRESS`需定义以启用重定位。
- **寄存器操作**：
  - `SCB->VTOR`（向量表偏移寄存器）设置新基址。
  - `VECT_TAB_BASE_ADDRESS`：基地址（如SRAM起始地址`0x20000000`）。
  - `VECT_TAB_OFFSET`：偏移量（通常为0，或对齐到512字节边界）。
- **注意事项**：
  - 需提前将向量表内容复制到目标地址。
  - 地址必须对齐（如STM32F4要求至少512字节对齐）。

---

### **潜在缺失部分**
标准库中的`SystemInit`通常还包括：
- **时钟配置**：初始化PLL、设置系统时钟频率（如180MHz）。
- **Flash预取/ART加速**：配置等待周期，启用ART加速缓存。
- **其他外设初始化**：如电源控制、复位时钟配置。

当前代码可能是定制版本，需结合工程其他部分确认是否完整。

- **时钟配置**：初始化PLL、设置系统时钟频率（如180MHz）。
- **Flash预取/ART加速**：配置等待周期，启用ART加速缓存。
- **其他外设初始化**：如电源控制、复位时钟配置。

当前代码可能是定制版本，需结合工程其他部分确认是否完整。

- **Flash预取/ART加速**：配置等待周期，启用ART加速缓存。
- **其他外设初始化**：如电源控制、复位时钟配置。

当前代码可能是定制版本，需结合工程其他部分确认是否完整。


当前代码可能是定制版本，需结合工程其他部分确认是否完整。

当前代码可能是定制版本，需结合工程其他部分确认是否完整。


---

### **关键配置依赖**
- **宏定义**：
  - `DATA_IN_ExtSRAM/DATA_IN_ExtSDRAM`：启用外部存储器初始化。
  - `USER_VECT_TAB_ADDRESS`：触发向量表重定位。
- **链接脚本**：
  - 若使用外部存储器，需在链接脚本中指定数据段（`.data`、`.bss`）到外部内存地址。

---

### **总结**
该`SystemInit`函数为STM32F429提供了基础初始化：
1. **FPU启用**：确保浮点运算高效执行。
2. **外部存储器支持**：扩展数据存储空间。
3. **向量表重定位**：适应中断处理的特殊需求（如固件升级、动态加载）。
